name: Release Runtime Package

on:
  repository_dispatch:
    types:
      - runtime-image-published
  workflow_dispatch:
    inputs:
      runtime_version:
        description: Runtime release version (vX.Y.Z or vX.Y.Z-suffix)
        required: true
        type: string
      app_image:
        description: App image reference (eg. ghcr.io/pvtl/student-data-wall-docker:sha-abc1234)
        required: true
        type: string
      publish_release:
        description: Publish tag/release? (un-check to build artifact only)
        required: true
        default: true
        type: boolean

permissions:
  contents: write

env:
  RUNTIME_NAME: docker-runtime

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout runtime repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Resolve and validate inputs
        run: |
          set -euo pipefail

          if [[ "${GITHUB_EVENT_NAME}" == "repository_dispatch" ]]; then
            raw_version="${{ github.event.client_payload.version }}"
            raw_image="${{ github.event.client_payload.image }}"
            publish_release="true"
            trigger_source="repository_dispatch"
          else
            raw_version="${{ inputs.runtime_version }}"
            raw_image="${{ inputs.app_image }}"
            publish_release="${{ inputs.publish_release }}"
            trigger_source="workflow_dispatch"
          fi

          if [[ -z "${raw_version}" || -z "${raw_image}" ]]; then
            echo "Missing required runtime_version or app_image."
            exit 1
          fi

          if [[ "${raw_version}" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+([.-][0-9A-Za-z]+)*$ ]]; then
            normalized_version="${raw_version}"
            if [[ "${normalized_version}" != v* ]]; then
              normalized_version="v${normalized_version}"
            fi
          else
            echo "runtime_version must use X.Y.Z, vX.Y.Z, or include a suffix like -r1."
            exit 1
          fi

          if [[ "${raw_image}" =~ ^[[:space:]]*docker[[:space:]]+pull[[:space:]]+(.+)$ ]]; then
            normalized_image="${BASH_REMATCH[1]}"
          else
            normalized_image="${raw_image}"
          fi

          # Trim any accidental leading/trailing whitespace from the image ref.
          normalized_image="${normalized_image#"${normalized_image%%[![:space:]]*}"}"
          normalized_image="${normalized_image%"${normalized_image##*[![:space:]]}"}"

          if [[ "${normalized_image}" != ghcr.io/pvtl/student-data-wall-docker:* && "${normalized_image}" != ghcr.io/pvtl/student-data-wall-docker@sha256:* ]]; then
            echo "app_image must reference ghcr.io/pvtl/student-data-wall-docker with a tag or digest."
            exit 1
          fi

          if [[ "${normalized_image}" == *":latest" ]]; then
            echo "app_image must not use latest."
            exit 1
          fi

          {
            echo "RUNTIME_VERSION=${normalized_version}"
            echo "APP_IMAGE=${normalized_image}"
            echo "PUBLISH_RELEASE=${publish_release}"
            echo "TRIGGER_SOURCE=${trigger_source}"
          } >> "${GITHUB_ENV}"

      - name: Apply runtime metadata updates
        run: |
          set -euo pipefail

          tmp_file="$(mktemp)"
          awk -v image="${APP_IMAGE}" -v version="${RUNTIME_VERSION}" '
            BEGIN { updated_image=0; updated_version=0 }
            /^APP_IMAGE=/ {
              print "APP_IMAGE=" image
              updated_image=1
              next
            }
            /^RUNTIME_VERSION=/ {
              print "RUNTIME_VERSION=" version
              updated_version=1
              next
            }
            { print }
            END {
              if (updated_version == 0) {
                print "RUNTIME_VERSION=" version
              }
              if (updated_image == 0) {
                print "APP_IMAGE=" image
              }
            }
          ' .env.docker.example > "${tmp_file}"
          mv "${tmp_file}" .env.docker.example
          printf "%s\n" "${RUNTIME_VERSION}" > VERSION

      - name: Create runtime package
        run: |
          set -euo pipefail

          package_file="${RUNTIME_NAME}-${RUNTIME_VERSION}.tar.gz"
          rm -rf "${RUNTIME_NAME}"
          mkdir -p "${RUNTIME_NAME}"

          cp docker-compose.yml "${RUNTIME_NAME}/"
          cp .env.docker.example "${RUNTIME_NAME}/"
          cp VERSION "${RUNTIME_NAME}/"
          cp -r license "${RUNTIME_NAME}/"
          cp -r scripts "${RUNTIME_NAME}/"
          cp -r docs "${RUNTIME_NAME}/"

          tar -czf "${package_file}" "${RUNTIME_NAME}/"
          tar -tzf "${package_file}"
          echo "PACKAGE_FILE=${package_file}" >> "${GITHUB_ENV}"

      - name: Upload runtime artifact
        uses: actions/upload-artifact@v4
        with:
          name: runtime-${{ env.RUNTIME_VERSION }}-${{ github.run_id }}
          path: ${{ env.PACKAGE_FILE }}

      - name: Commit runtime metadata (if changed)
        if: env.PUBLISH_RELEASE == 'true'
        run: |
          set -euo pipefail
          if git diff --quiet -- .env.docker.example VERSION; then
            echo "No metadata file changes detected."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .env.docker.example VERSION
          git commit -m "chore: release runtime ${RUNTIME_VERSION}"
          git push origin main

      - name: Ensure release tag exists
        if: env.PUBLISH_RELEASE == 'true'
        run: |
          set -euo pipefail
          if [[ -n "$(git ls-remote --tags origin "refs/tags/${RUNTIME_VERSION}")" ]]; then
            echo "Tag already exists: ${RUNTIME_VERSION}"
            exit 0
          fi

          git tag "${RUNTIME_VERSION}"
          git push origin "${RUNTIME_VERSION}"

      - name: Publish runtime release
        if: env.PUBLISH_RELEASE == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RUNTIME_VERSION }}
          target_commitish: main
          name: Docker Runtime ${{ env.RUNTIME_VERSION }}
          files: ${{ env.PACKAGE_FILE }}
          fail_on_unmatched_files: true
          body: |
            The next version of Student Data Wall is now available!

            ## Installing
            ```bash
            wget https://github.com/pvtl/student-data-wall-docker/releases/download/${{ env.RUNTIME_VERSION }}/docker-runtime-${{ env.RUNTIME_VERSION }}.tar.gz
            tar -xzf docker-runtime-${{ env.RUNTIME_VERSION }}.tar.gz
            cd docker-runtime
            # Copy your license file to "license/license.lic"
            ./scripts/sdw install
            ```

            ## Updating
            ```bash
            cd docker-runtime
            ./scripts/sdw update --target ${{ env.RUNTIME_VERSION }}
            ```

            ## Release Details

            - Runtime version: `${{ env.RUNTIME_VERSION }}`
            - App image: `${{ env.APP_IMAGE }}`
            - Trigger source: `${{ env.TRIGGER_SOURCE }}`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
